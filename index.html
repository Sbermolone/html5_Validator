<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HTML5 Creative Validator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:linear-gradient(180deg,#e6f0fa 0%,#f8fbfe 100%);color:#1e3a5f}
  .panel{background:#fff;border-radius:1rem;box-shadow:0 4px 12px rgba(30,58,95,.1)}
  .badge{display:inline-flex;align-items:center;border-radius:9999px;padding:2px 10px;font-size:12px;font-weight:600;background:#0f3b82;color:#fff}
  .btn{background:#2563eb;color:#fff;padding:.5rem 1.25rem;border-radius:.75rem;font-weight:500}
  .btn:hover{background:#1d4ed8}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;z-index:50;background:#0f3b82;color:#fff;
         padding:10px 14px;border-radius:9999px;box-shadow:0 6px 18px rgba(15,59,130,.25);display:none}
  #alert{display:none}
  #previewCard{display:none}
  #previewFrame{width:100%;height:350px;border:1px solid #c7ddff;border-radius:.75rem;background:#fff}
  code.small{background:#eef5ff;padding:0 6px;border-radius:6px}
</style>
</head>
<body>
<div class="max-w-5xl mx-auto p-6">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold mb-2">HTML5 Creative Validator</h1>
    <p class="text-base text-blue-900">Upload your HTML5 banner ZIP and check it instantly.</p>
  </header>

  <!-- Error banner -->
  <div id="alert" class="mb-4 panel border border-red-200">
    <div class="p-4">
      <div class="flex items-start gap-3">
        <div class="mt-0.5 h-5 w-5 rounded-full bg-red-600 flex items-center justify-center text-white text-xs">!</div>
        <div class="flex-1">
          <div class="font-semibold text-red-700">Validation failed</div>
          <div id="alertMsg" class="mt-1 text-sm text-red-800"></div>
        </div>
        <button id="alertClose" class="text-red-700 hover:underline text-sm">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <section class="panel mb-6 p-6">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
      <div class="flex-1">
        <label for="ruleset" class="block text-sm font-medium text-blue-900">Ruleset</label>
        <select id="ruleset" class="mt-1 w-full rounded-lg border-blue-200 focus:ring-blue-400 focus:border-blue-400">
          <option value="cm360">CM360 (150KB initial / 2.2MB total)</option>
          <option value="dv360">DV360 (200KB initial / 5MB total)</option>
          <option value="gam">Google Ad Manager</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-blue-900">Initial load limit (KB)</label>
        <input id="initialKB" type="number" value="150" class="mt-1 w-full rounded-lg border-blue-200 focus:ring-blue-400 focus:border-blue-400">
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-blue-900">Total load cap (KB)</label>
        <input id="totalKB" type="number" value="2200" class="mt-1 w-full rounded-lg border-blue-200 focus:ring-blue-400 focus:border-blue-400">
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-blue-900">ZIP size cap (KB)</label>
        <input id="zipKB" type="number" value="200" class="mt-1 w-full rounded-lg border-blue-200 focus:ring-blue-400 focus:border-blue-400">
      </div>
    </div>
    <div class="mt-4 flex items-center gap-3">
      <input id="strictCM360" type="checkbox" class="rounded border-blue-300 text-blue-600 focus:ring-blue-400">
      <label for="strictCM360" class="text-sm text-blue-900">Strict CM360 mode (treat missing <code class="small">ad.size</code>, non-root <code class="small">index.html</code>, and external URLs as errors)</label>
    </div>
  </section>

  <!-- Dropzone -->
  <section id="dropzone" class="panel mb-8 p-8 text-center border-2 border-dashed border-blue-300 hover:border-blue-400 transition">
    <p class="text-lg font-medium text-blue-900">Drag & drop your ZIP here</p>
    <p class="text-sm text-blue-700 mb-3">or</p>
    <input id="fileInput" type="file" accept=".zip" class="block mx-auto mb-2">
    <div class="text-xs text-blue-800">Tip: if you pick the same file again, this still re-validates.</div>
    <div id="picked" class="mt-3 text-sm text-blue-800"></div>
  </section>

  <!-- Summary -->
  <section id="results" class="hidden mb-6">
    <div id="summary" class="mb-4"></div>
  </section>

  <!-- Preview -->
  <section id="previewCard" class="panel mb-6 p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-blue-900">Preview</h3>
      <div class="text-xs text-blue-800">Sandboxed preview (assets served from memory)</div>
    </div>
    <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-pointer-lock allow-popups allow-modals"></iframe>
  </section>

  <!-- Initial Load Breakdown -->
  <section id="initialBreakdown" class="panel mb-8 p-4 hidden">
    <h3 class="font-semibold text-blue-900 mb-2">Initial Load Breakdown</h3>
    <div class="text-xs text-blue-800 mb-3">Assets counted toward initial load and where they came from.</div>
    <div class="overflow-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-blue-900">
            <th class="py-2 pr-3">Asset</th>
            <th class="py-2 pr-3">Source</th>
            <th class="py-2 pr-3">Size (KB)</th>
          </tr>
        </thead>
        <tbody id="initialRows"></tbody>
      </table>
    </div>
  </section>

  <!-- Details -->
  <section id="details" class="hidden mb-10">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="panel p-4">
        <h2 class="font-semibold mb-2 text-blue-900">Errors</h2>
        <ul id="errors" class="list-disc pl-5 text-red-700"></ul>
      </div>
      <div class="panel p-4">
        <h2 class="font-semibold mb-2 text-blue-900">Warnings</h2>
        <ul id="warnings" class="list-disc pl-5 text-amber-600"></ul>
      </div>
    </div>
    <div class="mt-6 panel p-4">
      <h3 class="font-semibold mb-3 text-blue-900">Info</h3>
      <div id="info" class="text-sm text-blue-800 space-y-1"></div>
    </div>
    <div class="mt-6 flex flex-wrap gap-3">
      <button id="downloadJson" class="btn">Download JSON</button>
      <button id="downloadCsv" class="btn">Download CSV</button>
    </div>
  </section>
</div>

<div id="toast">Validating…</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);

  // Toast & alerts
  const showToast = (m="Validating…") => { const t=$("#toast"); t.textContent=m; t.style.display="block"; };
  const hideToast = () => { $("#toast").style.display="none"; };
  const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const showAlert = msgs => {
    const list = Array.isArray(msgs) ? msgs : [String(msgs)];
    $("#alertMsg").innerHTML = "<ul class='list-disc pl-5'>" + list.map(m => "<li>"+escapeHtml(m)+"</li>").join("") + "</ul>";
    $("#alert").style.display = "block";
  };
  const hideAlert = () => $("#alert").style.display="none";
  $("#alertClose").addEventListener("click", hideAlert);

  // Rulesets UI
  const DEFAULT_RULESETS = {
    cm360:{initialKB:150,totalKB:2200,zipKB:200},
    dv360:{initialKB:200,totalKB:5000,zipKB:200},
    gam:{initialKB:150,totalKB:2200,zipKB:200},
    custom:{initialKB:150,totalKB:2200,zipKB:200}
  };
  const setRulesetUI = key => {
    const r = DEFAULT_RULESETS[key] || DEFAULT_RULESETS.custom;
    $("#initialKB").value = r.initialKB;
    $("#totalKB").value = r.totalKB;
    $("#zipKB").value = r.zipKB;
  };
  $("#ruleset").addEventListener("change", e => setRulesetUI(e.target.value));
  setRulesetUI("cm360");

  // Drag & drop
  const dropzone = $("#dropzone");
  dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("bg-blue-50"); });
  dropzone.addEventListener("dragleave", () => dropzone.classList.remove("bg-blue-50"));
  dropzone.addEventListener("drop", e => {
    e.preventDefault(); dropzone.classList.remove("bg-blue-50");
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file) { $("#picked").textContent = `Selected: ${file.name}`; startValidation(file); }
  });

  // File input (make sure change always fires, even for same file)
  const input = $("#fileInput");
  input.addEventListener("click", () => { input.value = ""; }); // key fix: reset so same file re-triggers change
  input.addEventListener("change", e => {
    const file = e.target.files && e.target.files[0];
    if (file) { $("#picked").textContent = `Selected: ${file.name}`; startValidation(file); }
  });

  // Helpers
  const bytesToKB = b => Math.round(b/1024);
  const bytesToMB = b => Math.round((b/(1024*1024))*100)/100;

  let previewUrls = [];

  function startValidation(file){
    hideAlert();
    showToast("Validating…");
    setTimeout(() => validateZip(file).catch(err => {
      hideToast(); showAlert(["Unexpected error while validating.", err?.message || String(err)]);
    }), 50);
  }

  async function validateZip(file){
    // Reset preview + breakdown
    previewUrls.forEach(URL.revokeObjectURL); previewUrls = [];
    $("#previewCard").style.display = "none";
    $("#previewFrame").src = "about:blank";
    $("#initialBreakdown").classList.add("hidden");
    $("#initialRows").innerHTML = "";

    const strict = $("#strictCM360").checked;
    const rules = {
      initialKB: +$("#initialKB").value || 150,
      totalKB: +$("#totalKB").value || 2200,
      zipKB: +$("#zipKB").value || 200
    };
    const errors = [], warnings = [], info = [], initialItems = [];

    // ZIP size
    const zipSizeKB = bytesToKB(file.size);
    if (zipSizeKB > rules.zipKB) errors.push(`ZIP size ${zipSizeKB}KB exceeds cap ${rules.zipKB}KB.`);
    else info.push(`ZIP size: ${zipSizeKB}KB`);

    // Load ZIP
    let zip;
    try {
      zip = await JSZip.loadAsync(await file.arrayBuffer());
    } catch (err){
      errors.push("Failed to read ZIP: " + err.message);
      return finish({errors,warnings,info,summaryStatus:"FAIL"});
    }

    // Read entries
    const files = [];
    await Promise.all(Object.keys(zip.files).map(async (path) => {
      const entry = zip.files[path];
      if (entry.dir) return;
      const ext = (path.split('.').pop() || '').toLowerCase();
      const textLike = /^(html?|css|js|svg|txt|json)$/i.test(ext);
      let bin = null, text = "";
      try {
        bin = await entry.async("uint8array");
        if (textLike) { try { text = new TextDecoder("utf-8").decode(bin); } catch{} }
      } catch(e){}
      const size = bin ? bin.byteLength : (entry._data?.uncompressedSize || 0);
      files.push({ path, size, ext, bin, text });
    }));

    const totalBytes = files.reduce((s,f)=>s+f.size,0);
    const totalUnzippedKB = bytesToKB(totalBytes);
    info.push(`Unzipped total: ${totalUnzippedKB}KB (${bytesToMB(totalBytes)}MB)`);

    // helpers
    const norm = p => (p||"").replace(/^\.?\//,'');
    const dirname = p => norm(p).replace(/\/[^\/]*$/,"");
    const fileSizeMap = new Map(files.map(f => [norm(f.path), f.size]));
    const fileTextMap = new Map(files.map(f => [norm(f.path), f.text]));

    // index.html
    const indexFile = files.find(f => /(^|\/)index\.html$/i.test(f.path));
    if (!indexFile) errors.push("Missing index.html.");
    else if (!/^index\.html$/i.test(indexFile.path)) (strict?errors:warnings).push(`index.html is nested at ${indexFile.path}. Many ad servers expect it at the root.`);
    const idxDir = indexFile ? dirname(indexFile.path) : "";

    // Blocked types
    const blocked = files.filter(f => /\.(exe|bat|cmd|sh|php|py|jar|dll)$/i.test(f.path));
    if (blocked.length) errors.push(`Blocked file types present: ${blocked.map(f=>f.path).join(", ")}`);

    // External URLs & HTTP
    const extUrlPattern = /\b(?:src|href)\s*=\s*["']([^"']+)["']/gi;
    const externalUrls = new Set(), httpUrls = new Set();
    for (const f of files){
      if (!f.text) continue;
      let m; const t = f.text;
      while ((m = extUrlPattern.exec(t)) !== null) {
        const url = m[1];
        if (/^data:|^mailto:|^tel:|^#/.test(url)) continue;
        if (/^https?:\/\//i.test(url) || /^\/\//.test(url)) {
          externalUrls.add(url);
          if (/^http:\/\//i.test(url)) httpUrls.add(url);
        }
      }
    }
    if (externalUrls.size) (strict?errors:warnings).push(`External asset URLs found (${externalUrls.size}). Examples: ${Array.from(externalUrls).slice(0,3).join(", ")}`);
    if (httpUrls.size) errors.push(`Insecure HTTP URLs found: ${Array.from(httpUrls).slice(0,3).join(", ")}… Use HTTPS.`);

    // ad.size + refs
    let hasClickTag=false, hasEnablerExit=false, initialAssetBytes=0;
    if (indexFile && indexFile.text){
      const parser = new DOMParser();
      const doc = parser.parseFromString(indexFile.text, "text/html");

      const meta = doc.querySelector('meta[name="ad.size"]');
      if (meta && meta.content) info.push(`ad.size: ${meta.content}`);
      else (strict?errors:warnings).push('Missing <meta name="ad.size">.');

      const refPairs = [];
      doc.querySelectorAll("img[src]").forEach(el => refPairs.push({url:el.getAttribute("src"), source:"<img src>"}));
      doc.querySelectorAll('link[rel="stylesheet"][href]').forEach(el => refPairs.push({url:el.getAttribute("href"), source:'<link rel="stylesheet" href>'}));
      doc.querySelectorAll("script[src]").forEach(el => refPairs.push({url:el.getAttribute("src"), source:"<script src>"}));
      doc.querySelectorAll("video source[src]").forEach(el => refPairs.push({url:el.getAttribute("src"), source:"<video> source[src]"}));
      doc.querySelectorAll("audio source[src]").forEach(el => refPairs.push({url:el.getAttribute("src"), source:"<audio> source[src]"}));

      const resolveFromIndex = u => {
        let rr = (u||"").replace(/^\.?\//,'');
        if (/^data:|^https?:|^\/\//i.test(rr) || /^#/.test(rr)) return null;
        return norm(idxDir ? (idxDir + "/" + rr) : rr);
      };

      // Direct refs
      for (const {url, source} of refPairs){
        const p = resolveFromIndex(url); if (!p) continue;
        const size = fileSizeMap.get(p);
        if (size){ initialAssetBytes += size; initialItems.push({path:p, size, source}); }
      }

      // Linked CSS
      const linkedCss = refPairs.filter(r => r.source.includes("stylesheet")).map(r => resolveFromIndex(r.url)).filter(Boolean);
      for (const cssPath of linkedCss){
        const cssText = fileTextMap.get(cssPath) || "";
        const baseDir = dirname(cssPath);
        cssText.replace(/url\(([^)]+)\)/g, (m, raw) => {
          let ref = raw.trim().replace(/^['"]|['"]$/g,"");
          if (/^data:|^https?:|^\/\//i.test(ref) || /^#/.test(ref)) return m;
          let joined = norm(baseDir ? (baseDir + "/" + ref) : ref);
          const size = fileSizeMap.get(joined);
          if (size){ initialAssetBytes += size; initialItems.push({path:joined, size, source:`${cssPath} → url(...)`}); }
          return m;
        });
      }

      // Inline <style>
      Array.from(doc.querySelectorAll("style")).forEach(s => {
        const cssText = s.textContent || "";
        cssText.replace(/url\(([^)]+)\)/g, (m, raw) => {
          let ref = raw.trim().replace(/^['"]|['"]$/g,"");
          if (/^data:|^https?:|^\/\//i.test(ref) || /^#/.test(ref)) return m;
          let joined = resolveFromIndex(ref); if (!joined) return m;
          const size = fileSizeMap.get(joined);
          if (size){ initialAssetBytes += size; initialItems.push({path:joined, size, source:`inline <style> → url(...)`}); }
          return m;
        });
      });

      // style="" attributes
      Array.from(doc.querySelectorAll("[style]")).forEach(el => {
        const cssText = el.getAttribute("style") || "";
        cssText.replace(/url\(([^)]+)\)/g, (m, raw) => {
          let ref = raw.trim().replace(/^['"]|['"]$/g,"");
          if (/^data:|^https?:|^\/\//i.test(ref) || /^#/.test(ref)) return m;
          let joined = resolveFromIndex(ref); if (!joined) return m;
          const size = fileSizeMap.get(joined);
          if (size){ initialAssetBytes += size; initialItems.push({path:joined, size, source:`style="" → url(...)`}); }
          return m;
        });
      });

      // click handling
      const html = indexFile.text;
      hasClickTag = /\b(clickTag|clickTAG|clicktag)\b/.test(html);
      hasEnablerExit = /\bEnabler\s*\.\s*exit\s*\(/.test(html);
    }

    // JS scan too
    if (!hasClickTag || !hasEnablerExit){
      const jsMatchesCT = files.some(f => f.ext === "js" && /\b(clickTag|clickTAG|clicktag)\b/.test(f.text || ""));
      const jsMatchesEn = files.some(f => f.ext === "js" && /\bEnabler\s*\.\s*exit\s*\(/.test(f.text || ""));
      hasClickTag = hasClickTag || jsMatchesCT;
      hasEnablerExit = hasEnablerExit || jsMatchesEn;
    }
    if (!hasClickTag && !hasEnablerExit) errors.push("Missing click handling: expected global clickTag or Studio Enabler.exit().");
    else info.push("Click handling detected: " + [hasClickTag ? "clickTag" : null, hasEnablerExit ? "Enabler.exit" : null].filter(Boolean).join(" + "));

    // doc.write
    if (files.some(f => (f.text||"").includes("document.write("))) warnings.push("Usage of document.write() detected; often discouraged for ads.");

    // Size checks + breakdown
    const initialKB = bytesToKB(initialAssetBytes);
    if (initialKB > rules.initialKB) errors.push(`Estimated initial load ${initialKB}KB exceeds cap ${rules.initialKB}KB.`);
    else info.push(`Estimated initial load: ${initialKB}KB`);
    if (totalUnzippedKB > rules.totalKB) errors.push(`Total unzipped size ${totalUnzippedKB}KB exceeds cap ${rules.totalKB}KB.`);

    // Preview
    if (indexFile) { try { await buildPreview(files, indexFile, previewUrls); } catch(e){ warnings.push("Preview rendering failed: " + (e?.message || e)); } }

    // Breakdown table
    if (initialItems.length){
      $("#initialBreakdown").classList.remove("hidden");
      $("#initialRows").innerHTML = initialItems.sort((a,b)=>b.size-a.size)
        .map(it => `<tr class="border-t border-blue-100"><td class="py-2 pr-3 text-blue-900 break-all">${escapeHtml(it.path)}</td><td class="py-2 pr-3 text-blue-800">${escapeHtml(it.source)}</td><td class="py-2 pr-3">${bytesToKB(it.size)}</td></tr>`).join("");
    }

    const summaryStatus = errors.length ? "FAIL" : (warnings.length ? "WARN" : "PASS");
    return finish({errors,warnings,info,summaryStatus,meta:{zipKB:zipSizeKB,totalKB:totalUnzippedKB,initialKB}});
  }

  function finish(payload){
    hideToast();
    if (payload.summaryStatus === "FAIL") showAlert(payload.errors?.length ? payload.errors : "The file failed validation.");
    else hideAlert();
    showResults(payload);
  }

  function showResults({errors,warnings,info,summaryStatus}){
    $("#results").classList.remove("hidden");
    $("#details").classList.remove("hidden");

    const tone = summaryStatus==="PASS" ? "bg-blue-100 border-blue-300" :
                 summaryStatus==="WARN" ? "bg-blue-50 border-blue-200" :
                 "bg-blue-50 border-blue-300";
    $("#summary").innerHTML =
      `<div class="rounded-2xl border p-4 ${tone}">
         <div class="flex items-center gap-3">
           <div class="badge">${summaryStatus}</div>
           <div class="text-sm text-blue-900">
             Errors: <strong>${errors.length}</strong> · Warnings: <strong>${warnings.length}</strong>
           </div>
         </div>
       </div>`;

    const eul=$("#errors"); eul.innerHTML=""; errors.forEach(e=>{const li=document.createElement("li"); li.textContent=e; eul.appendChild(li);});
    const wul=$("#warnings"); wul.innerHTML=""; warnings.forEach(w=>{const li=document.createElement("li"); li.textContent=w; wul.appendChild(li);});
    const inf=$("#info"); inf.innerHTML=""; info.forEach(i=>{const p=document.createElement("div"); p.textContent="• "+i; inf.appendChild(p);});

    // downloads
    const payload = { status: summaryStatus, errors, warnings, info };
    $("#downloadJson").onclick = () => downloadBlob(JSON.stringify(payload,null,2),"h5-validator-results.json","application/json");
    const rows = [].concat(errors.map(m=>({category:"ERROR",message:m}))).concat(warnings.map(m=>({category:"WARNING",message:m})));
    const csv = "category,message\n" + rows.map(r => JSON.stringify(r.category)+","+JSON.stringify(r.message)).join("\n");
    $("#downloadCsv").onclick = () => downloadBlob(csv,"h5-validator-results.csv","text/csv");
  }

  function downloadBlob(content, filename, type){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 200);
  }

  // Preview builder
  const MIME = {html:"text/html",htm:"text/html",css:"text/css",js:"text/javascript",mjs:"text/javascript",
    png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",
    mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",mp3:"audio/mpeg",wav:"audio/wav",json:"application/json",
    txt:"text/plain",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",otf:"font/otf"};

  async function buildPreview(files, indexFile, previewUrls){
    const urlMap = new Map();
    const norm = p => (p||"").replace(/^\.?\//,'');
    const dirOf = p => norm(p).replace(/\/[^\/]*$/,"");

    // blobs for all
    for (const f of files){
      if (!f.bin) continue;
      const blob = new Blob([f.bin], {type: MIME[f.ext] || "application/octet-stream"});
      const u = URL.createObjectURL(blob); urlMap.set(norm(f.path), u); previewUrls.push(u);
    }

    // rewrite CSS
    for (const f of files.filter(x => x.ext==="css" && typeof x.text==="string")){
      const baseDir = dirOf(f.path);
      const rewritten = (f.text||"").replace(/url\(([^)]+)\)/g,(m,raw)=>{
        let ref = raw.trim().replace(/^['"]|['"]$/g,"");
        if (/^data:|^https?:|^\/\//i.test(ref)) return m;
        const joined = norm(baseDir ? (baseDir+"/"+ref) : ref);
        const target = urlMap.get(joined);
        return target ? `url(${target})` : m;
      });
      const blob = new Blob([rewritten], {type:"text/css"});
      const u = URL.createObjectURL(blob); previewUrls.push(u);
      urlMap.set(norm(f.path), u);
    }

    // rewrite index.html
    const parser = new DOMParser();
    const doc = parser.parseFromString(indexFile.text||"", "text/html");
    const rewriteAttr = (sel,attr)=>{
      doc.querySelectorAll(sel).forEach(el=>{
        const v = el.getAttribute(attr);
        if (!v || /^data:|^https?:|^\/\//i.test(v) || /^#/.test(v)) return;
        const idxDir = dirOf(indexFile.path);
        let joined = v.replace(/^\.?\//,''); if (idxDir) joined = (idxDir+"/"+joined).replace(/^\//,'');
        const blobUrl = urlMap.get(norm(joined)); if (blobUrl) el.setAttribute(attr, blobUrl);
      });
    };
    rewriteAttr("script[src]","src");
    rewriteAttr('link[rel="stylesheet"][href]',"href");
    rewriteAttr("img[src]","src");
    rewriteAttr("video source[src]","src");
    rewriteAttr("audio source[src]","src");

    const htmlUrl = URL.createObjectURL(new Blob(["<!DOCTYPE html>\n"+doc.documentElement.outerHTML], {type:"text/html"}));
    previewUrls.push(htmlUrl);
    const frame = document.querySelector("#previewFrame");
    frame.src = htmlUrl;
    document.querySelector("#previewCard").style.display = "block";
  }
});
</script>
</body>
</html>
